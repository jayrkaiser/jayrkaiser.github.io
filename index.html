<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>BadDuck Gang ‚Äî Live (Supabase)</title>
<style>
:root{--bg:#fffaf5;--card:#fff;--soft:#ffe7ef;--text:#563a32;--muted:#9a7a71;--prim:#ff9bb5;--accent:#ffd38d;--ok:#3fb984;--warn:#ffb84d;--danger:#ff6b6b;--bd:1px solid rgba(0,0,0,.08);--shadow:0 8px 24px rgba(0,0,0,.06)}
*{box-sizing:border-box}html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans Thai',sans-serif}
.appbar{position:sticky;top:0;display:flex;justify-content:space-between;align-items:center;padding:12px 14px;background:linear-gradient(90deg,#ffc3d2,#ffe0b8);box-shadow:var(--shadow)}
.container{padding:14px;max-width:1000px;margin:0 auto}
nav.tabs{display:flex;flex-wrap:wrap;gap:6px;margin:10px 0}
nav.tabs button{border:0;background:var(--soft);color:var(--text);padding:8px 12px;border-radius:999px}
nav.tabs button.active{background:#ffd8c0}
.view{display:none}.view.active{display:block}
.card{background:var(--card);border:var(--bd);border-radius:16px;padding:14px;box-shadow:var(--shadow);margin-bottom:12px}
.h{font-weight:800;margin:6px 0 10px}.small{color:var(--muted);font-size:.9rem}
.row{display:grid;gap:10px}.g2{grid-template-columns:1fr 1fr}.g3{grid-template-columns:1fr 1fr 1fr}
input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:var(--bd);background:#fff}
.btn{border:0;border-radius:12px;padding:10px 12px;font-weight:700;cursor:pointer}
.btn-primary{background:var(--prim);color:#fff}.btn-soft{background:var(--soft)}.btn-danger{background:var(--danger);color:#fff}
.list{list-style:none;margin:0;padding:0}.item{display:flex;justify-content:space-between;gap:10px;padding:10px 12px;border-bottom:var(--bd)}
.badge{padding:4px 10px;border-radius:999px;background:#f3f4f6}
.kv{display:grid;grid-template-columns:1fr auto;gap:8px}
</style>
</head>
<body>
<header class="appbar">
  <b>ü¶Ü BadDuck family ‚Äî Live</b>
  <div>
    <span id="me" class="small">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‚Ä¶</span>
    <button id="loginBtn" class="btn btn-soft">Login Discord</button>
    <button id="logoutBtn" class="btn btn-danger" style="display:none">Logout</button>
  </div>
</header>

<main class="container">
  <nav class="tabs">
    <button data-target="v-members" class="active">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
    <button data-target="v-items">‡πÑ‡∏≠‡πÄ‡∏ó‡∏°</button>
    <button data-target="v-acts">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°/‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</button>
    <button data-target="v-fines">‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö</button>
    <button data-target="v-fin">‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</button>
    <button data-target="v-leave">‡∏•‡∏≤</button>
    <button data-target="v-reports">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
  </nav>

  <!-- MEMBERS -->
  <section id="v-members" class="view active">
    <div class="card">
      <div class="h">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div>
      <div class="row g2">
        <input id="mName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•">
        <select id="mRole"><option value="member">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</option><option value="leader">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô</option><option value="admin">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</option></select>
      </div>
      <div class="row g2">
        <input id="mHouse" placeholder="‡∏ö‡πâ‡∏≤‡∏ô (‡∏ö‡πâ‡∏≤‡∏ô A/B/...)">
        <input id="mDiscord" placeholder="Discord ID (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
      </div>
      <button class="btn btn-primary" id="addMember">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
    </div>
    <div class="card">
      <div class="kv"><div class="h">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</div><div class="small" id="memberCount"></div></div>
      <ul class="list" id="memberList"></ul>
    </div>
  </section>

  <!-- ITEMS -->
  <section id="v-items" class="view">
    <div class="card">
      <div class="h">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡πÄ‡∏ó‡∏°</div>
      <div class="row g2">
        <input id="iName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏≠‡πÄ‡∏ó‡∏°">
        <input id="iQty" type="number" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô">
      </div>
      <div class="row g2">
        <input id="iCat" placeholder="‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà">
        <select id="iCond"><option value="new">‡πÉ‡∏´‡∏°‡πà</option><option value="good">‡∏î‡∏µ</option><option value="used">‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏ä‡πâ</option><option value="broken">‡∏ä‡∏≥‡∏£‡∏∏‡∏î</option></select>
      </div>
      <div class="row g2">
        <select id="iOwner"></select>
        <input id="iNote" placeholder="‡πÇ‡∏ô‡πâ‡∏ï">
      </div>
      <button class="btn btn-primary" id="addItem">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡πÄ‡∏ó‡∏°</button>
    </div>
    <div class="card">
      <div class="h">‡∏Ñ‡∏•‡∏±‡∏á‡πÑ‡∏≠‡πÄ‡∏ó‡∏°</div>
      <ul class="list" id="itemList"></ul>
    </div>
  </section>

  <!-- ACTIVITIES + ATTENDANCE -->
  <section id="v-acts" class="view">
    <div class="card">
      <div class="h">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</div>
      <div class="row g2">
        <input id="aName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°">
        <input id="aStart" type="datetime-local">
      </div>
      <div class="row g2">
        <input id="aEnd" type="datetime-local" placeholder="‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏¥‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
        <select id="aRequired"><option value="true">‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</option><option value="false">‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö</option></select>
      </div>
      <input id="aPenalty" type="number" placeholder="‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏≤‡∏î (‡∏ø) ‡πÄ‡∏ä‡πà‡∏ô 50">
      <button class="btn btn-primary" id="addAct">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
    </div>
    <div class="card">
      <div class="h">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° + ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</div>
      <ul class="list" id="actList"></ul>
    </div>
  </section>

  <!-- FINES -->
  <section id="v-fines" class="view">
    <div class="card">
      <div class="h">‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö (‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î)</div>
      <ul class="list" id="fineList"></ul>
    </div>
  </section>

  <!-- FINANCE -->
  <section id="v-fin" class="view">
    <div class="card">
      <div class="h">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</div>
      <div class="row g2">
        <input id="fDesc" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏Ñ‡πà‡∏≤‡∏ö‡πâ‡∏≤‡∏ô/‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏Ñ/‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢)">
        <input id="fAmount" type="number" step="0.01" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (+/-)">
      </div>
      <div class="row g2">
        <select id="fUser"></select>
        <input id="fPeriod" placeholder="‡∏£‡∏≠‡∏ö (YYYY-MM)">
      </div>
      <button class="btn btn-primary" id="addFin">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
    <div class="card">
      <div class="kv"><div class="h">‡πÄ‡∏•‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</div><div class="small">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <b id="finBalance">‡∏ø 0</b></div></div>
      <ul class="list" id="ledgerList"></ul>
    </div>
  </section>

  <!-- LEAVES -->
  <section id="v-leave" class="view">
    <div class="card">
      <div class="h">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤</div>
      <div class="row g2">
        <select id="lUser"></select>
        <input id="lReason" placeholder="‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤">
      </div>
      <div class="row g2">
        <input id="lFrom" type="datetime-local">
        <input id="lTo" type="datetime-local">
      </div>
      <button class="btn btn-primary" id="addLeave">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠</button>
    </div>
    <div class="card">
      <div class="h">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠</div>
      <ul class="list" id="leaveList"></ul>
    </div>
  </section>

  <!-- REPORTS -->
  <section id="v-reports" class="view">
    <div class="card">
      <div class="h">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡πà‡∏≠</div>
      <div id="reportBox" class="small">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</div>
    </div>
  </section>
</main>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

/** ====== ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ====== **/
const SUPABASE_URL  = "https://kscmbueyiyirajmrkaoc.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
/** ============================ **/

const sb = createClient(SUPABASE_URL, SUPABASE_ANON, { auth: { persistSession: true } });

const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
$$('.tabs button').forEach(btn=>{
  btn.onclick=()=>{ $$('.tabs button').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
    $$('.view').forEach(v=>v.classList.remove('active')); $('#'+btn.dataset.target).classList.add('active'); };
});

$('#loginBtn').onclick = async () => {
  const { error } = await sb.auth.signInWithOAuth({ provider:'discord', options:{ redirectTo: location.origin }});
  if (error) alert(error.message);
};
$('#logoutBtn').onclick = async () => { await sb.auth.signOut(); location.reload(); };

sb.auth.onAuthStateChange(async (_evt, session) => {
  if (session?.user) {
    $('#me').textContent = session.user.user_metadata?.name || session.user.email || 'Logged in';
    $('#loginBtn').style.display = 'none';
    $('#logoutBtn').style.display = 'inline-block';
    await Promise.all([loadMembers(), loadItems(), loadActs(), loadFines(), loadLedger(), loadLeaves()]);
    fillMemberSelects();
    subscribeRealtime();
    renderReports();
  } else {
    $('#me').textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô';
    $('#loginBtn').style.display = 'inline-block';
    $('#logoutBtn').style.display = 'none';
  }
});

/* ===== MEMBERS ===== */
let _members = [];
async function loadMembers(){
  const { data, error } = await sb.from('users').select('*').order('created_at',{ascending:true});
  if (error) return alert(error.message);
  _members = data||[];
  $('#memberCount').textContent = `${_members.length} ‡∏Ñ‡∏ô`;
  $('#memberList').innerHTML = _members.map(m=>`
    <li class="item">
      <div><b>${m.username||'-'}</b><div class="small">${m.role}${m.house_id?' ¬∑ '+(m.house_id):''}${m.discord_id?' ¬∑ DC:'+m.discord_id:''}</div></div>
      <div><button class="btn btn-danger" onclick="window.__delMember('${m.id}')">‡∏•‡∏ö</button></div>
    </li>`).join('') || '<div class="small">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div>';
}
async function addMember(){
  const username = $('#mName').value.trim();
  const role = $('#mRole').value;
  const house = $('#mHouse').value.trim()||null;
  const discord_id = $('#mDiscord').value.trim()||null;
  if(!username) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠');
  const { error } = await sb.from('users').insert({ username, role, house_id: null, discord_id });
  if (error) alert(error.message);
  $('#mName').value=''; $('#mHouse').value=''; $('#mDiscord').value='';
}
async function delMember(id){
  if(!confirm('‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ô‡∏µ‡πâ?')) return;
  const { error } = await sb.from('users').delete().eq('id', id);
  if (error) alert(error.message);
}
$('#addMember').onclick = addMember;
window.__delMember = delMember;

function fillMemberSelects(){
  const opts = _members.map(m=>`<option value="${m.id}">${m.username}</option>`).join('');
  $('#iOwner').innerHTML = `<option value="">‡∏Ñ‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏≤‡∏á</option>` + opts;
  $('#fUser').innerHTML  = `<option value="">(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)</option>` + opts;
  $('#lUser').innerHTML  = opts;
}

/* ===== ITEMS ===== */
let _items = [];
async function loadItems(){
  const { data, error } = await sb.from('items').select('*').order('created_at',{ascending:true});
  if (error) return alert(error.message);
  _items = data||[];
  renderItems();
}
async function addItem(){
  const payload = {
    name: $('#iName').value.trim(),
    qty: parseInt($('#iQty').value||'0',10),
    cat: $('#iCat').value.trim()||null,
    cond: $('#iCond').value,
    owner_id: $('#iOwner').value||null,
    note: $('#iNote').value.trim()||null
  };
  if(!payload.name || !payload.qty || payload.qty<1) return alert('‡∏ä‡∏∑‡πà‡∏≠/‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
  const { error } = await sb.from('items').insert(payload);
  if (error) alert(error.message);
  $('#iName').value=''; $('#iQty').value=''; $('#iCat').value=''; $('#iNote').value='';
}
async function delItem(id){
  if(!confirm('‡∏•‡∏ö‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡∏ô‡∏µ‡πâ?')) return;
  const { error } = await sb.from('items').delete().eq('id',id);
  if (error) alert(error.message);
}
async function transferItem(id){
  const it = _items.find(x=>x.id===id); if(!it) return;
  const pick = prompt('‡πÇ‡∏≠‡∏ô‡πÉ‡∏´‡πâ (‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á) ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå "‡∏Ñ‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏≤‡∏á"', it.owner_id ? (_members.find(m=>m.id===it.owner_id)?.username||'‡∏Ñ‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏≤‡∏á'):'‡∏Ñ‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏≤‡∏á');
  if(pick===null) return;
  let owner_id = null;
  if(pick!=='‡∏Ñ‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏≤‡∏á'){
    const m=_members.find(x=>x.username===pick);
    if(!m) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ô‡∏µ‡πâ');
    owner_id = m.id;
  }
  const { error } = await sb.from('items').update({ owner_id }).eq('id', id);
  if (error) alert(error.message);
}
$('#addItem').onclick = addItem;

function renderItems(){
  $('#itemList').innerHTML = _items.map(it=>{
    const owner = it.owner_id ? (_members.find(m=>m.id===it.owner_id)?.username || '‚Äî') : '‡∏Ñ‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏≤‡∏á';
    return `<li class="item">
      <div><b>${it.name}</b> <span class="badge">${it.cond}</span>
        <div class="small">‡∏´‡∏°‡∏ß‡∏î: ${it.cat||'-'} ¬∑ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${it.qty} ¬∑ ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á: ${owner}</div>
        ${it.note?`<div class="small">‡πÇ‡∏ô‡πâ‡∏ï: ${it.note}</div>`:''}
      </div>
      <div>
        <button class="btn btn-soft" onclick="window.__transferItem('${it.id}')">‡πÇ‡∏≠‡∏ô</button>
        <button class="btn btn-danger" onclick="window.__delItem('${it.id}')">‡∏•‡∏ö</button>
      </div>
    </li>`;
  }).join('') || '<div class="small">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏≠‡πÄ‡∏ó‡∏°</div>';
}
window.__delItem = delItem;
window.__transferItem = transferItem;

/* ===== ACTIVITIES & ATTENDANCE ===== */
let _acts = [];
let _att = []; // ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô render

async function loadActs(){
  const { data, error } = await sb.from('activities').select('*').order('starts_at',{ascending:true});
  if (error) return alert(error.message);
  _acts = data||[];
  await renderActs();
}
async function addAct(){
  const name=$('#aName').value.trim();
  const starts=$('#aStart').value; const ends=$('#aEnd').value || null;
  const required = $('#aRequired').value === 'true';
  const penalty = parseInt($('#aPenalty').value||'50',10);
  if(!name || !starts) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°');
  const { error } = await sb.from('activities').insert({ name, starts_at: starts, ends_at: ends, required, penalty_amount: penalty });
  if (error) alert(error.message);
  $('#aName').value=''; $('#aStart').value=''; $('#aEnd').value=''; $('#aPenalty').value='';
}
$('#addAct').onclick = addAct;

async function setAttend(activity_id, user_id, status){
  const exists = await sb.from('attendance').select('id').eq('activity_id',activity_id).eq('user_id',user_id).maybeSingle();
  if (exists.data?.id) {
    await sb.from('attendance').update({ status }).eq('id', exists.data.id);
  } else {
    await sb.from('attendance').insert({ activity_id, user_id, status });
  }
}

async function renderActs(){
  // ‡πÇ‡∏´‡∏•‡∏î attendance ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ
  const ids = _acts.map(a=>a.id);
  if (ids.length){
    const { data } = await sb.from('attendance').select('*').in('activity_id', ids);
    _att = data||[];
  } else { _att = []; }

  $('#actList').innerHTML = _acts.map(a=>{
    const rows = _members.map(m=>{
      const rec = _att.find(x=>x.activity_id===a.id && x.user_id===m.id)?.status || '-';
      const chip = rec==='present'?'ok':rec==='late'?'warn':rec==='absent'?'danger':'';
      return `<div class="item">
        <div>${m.username}</div>
        <div class="small"><span class="badge ${chip}">${rec}</span></div>
        <div>
          <button class="btn btn-soft" onclick="window.__att('${a.id}','${m.id}','present')">‡∏°‡∏≤</button>
          <button class="btn btn-soft" onclick="window.__att('${a.id}','${m.id}','late')">‡∏™‡∏≤‡∏¢</button>
          <button class="btn btn-soft" onclick="window.__att('${a.id}','${m.id}','absent')">‡∏Ç‡∏≤‡∏î</button>
        </div>
      </div>`;
    }).join('');
    const req = a.required ? '<span class="badge">‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö</span>' : '';
    return `<li class="card"><div class="kv"><div><b>${a.name}</b><div class="small">${a.starts_at?.replace('T',' ')||''}</div></div><div>${req} ¬∑ ‡∏õ‡∏£‡∏±‡∏ö ${a.penalty_amount}‡∏ø</div></div>${rows}</li>`;
  }).join('') || '<div class="small">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</div>';
}
window.__att = setAttend;

/* ===== FINES ===== */
let _fines = [];
async function loadFines(){
  const { data, error } = await sb.from('fines').select('*').order('created_at',{ascending:false});
  if (error) return alert(error.message);
  _fines = data||[];
  renderFines();
}
async function settleFine(id){
  if(!confirm('‡∏õ‡∏¥‡∏î‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡∏ô‡∏µ‡πâ?')) return;
  const { error } = await sb.from('fines').update({ status:'settled', settled_at: new Date().toISOString() }).eq('id',id);
  if (error) alert(error.message);
  // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô ledger ‡∏ù‡∏±‡πà‡∏á client (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ trigger ‡∏ù‡∏±‡πà‡∏á DB ‡πÑ‡∏î‡πâ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á)
  const f = _fines.find(x=>x.id===id);
  if (f) { await sb.from('ledger').insert({ type:'payment', ref_table:'fines', ref_id:id, user_id:f.user_id, amount: Math.abs(f.amount), memo:'‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö' }); }
}
function renderFines(){
  $('#fineList').innerHTML = _fines.map(f=>{
    const u = _members.find(m=>m.id===f.user_id)?.username || '‚Äî';
    const st = f.status==='open' ? '<span class="badge">OPEN</span>' : '<span class="badge">SETTLED</span>';
    return `<li class="item">
      <div><b>${u}</b> <div class="small">‡∏õ‡∏£‡∏±‡∏ö: ${f.amount}‡∏ø ¬∑ ${new Date(f.created_at).toLocaleString()}</div></div>
      <div>${st} ${f.status==='open'?`<button class="btn btn-primary" onclick="window.__settle('${f.id}')">‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏±‡∏ö</button>`:''}</div>
    </li>`;
  }).join('') || '<div class="small">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö</div>';
}
window.__settle = settleFine;

/* ===== FINANCE / LEDGER ===== */
let _ledger = [];
async function loadLedger(){
  const { data, error } = await sb.from('ledger').select('*').order('at',{ascending:false});
  if (error) return alert(error.message);
  _ledger = data||[];
  renderLedger();
}
async function addFin(){
  const memo=$('#fDesc').value.trim();
  const amt=parseFloat($('#fAmount').value);
  const user_id=$('#fUser').value||null;
  const period=$('#fPeriod').value||null;
  if(!memo || isNaN(amt)) return alert('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£/‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
  const type = amt>=0 ? 'income' : 'expense';
  const { error } = await sb.from('ledger').insert({ type, ref_table:null, ref_id:null, user_id, amount:amt, memo, at:new Date().toISOString() });
  if (error) alert(error.message);
  $('#fDesc').value=''; $('#fAmount').value=''; $('#fPeriod').value='';
}
$('#addFin').onclick = addFin;

function renderLedger(){
  const rows = _ledger.map(x=>{
    const who = x.user_id ? (_members.find(m=>m.id===x.user_id)?.username || '‚Äî') : '‚Äî';
    const sign = Number(x.amount)>=0 ? '+' : '';
    return `<li class="item"><div><b>${x.memo}</b><div class="small">${new Date(x.at).toLocaleString()} ¬∑ ${who}</div></div><div class="badge">${sign}${x.amount}</div></li>`;
  }).join('') || '<div class="small">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>';
  $('#ledgerList').innerHTML = rows;
  const bal = _ledger.reduce((s,x)=>s+Number(x.amount||0),0);
  $('#finBalance').textContent = '‡∏ø '+bal.toFixed(2);
}

/* ===== LEAVES ===== */
let _leaves = [];
async function loadLeaves(){
  const { data, error } = await sb.from('leave_requests').select('*').order('created_at',{ascending:false});
  if (error) return alert(error.message);
  _leaves = data||[];
  renderLeaves();
}
async function addLeave(){
  const user_id=$('#lUser').value; const reason=$('#lReason').value.trim();
  const from_at=$('#lFrom').value||null; const to_at=$('#lTo').value||null;
  if(!user_id||!reason) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•');
  const { error } = await sb.from('leave_requests').insert({ user_id, reason, from_at, to_at });
  if (error) alert(error.message);
  $('#lReason').value=''; $('#lFrom').value=''; $('#lTo').value='';
}
$('#addLeave').onclick = addLeave;

function renderLeaves(){
  $('#leaveList').innerHTML = _leaves.map(l=>{
    const name=_members.find(m=>m.id===l.user_id)?.username || '‚Äî';
    return `<li class="item"><div><b>${name}</b><div class="small">${l.reason} ${l.from_at?(' ¬∑ '+l.from_at):''}${l.to_at?(' ‚Üí '+l.to_at):''}</div></div><div class="badge">${l.status}</div></li>`;
  }).join('') || '<div class="small">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠</div>';
}

/* ===== REPORTS (‡∏¢‡πà‡∏≠) ===== */
async function renderReports(){
  const openFines = _fines.filter(f=>f.status==='open').length;
  const byHouse = {}; _members.forEach(m=>{ byHouse[m.house_id||'‡∏≠‡∏∑‡πà‡∏ô‡πÜ']=(byHouse[m.house_id||'‡∏≠‡∏∑‡πà‡∏ô‡πÜ']||0)+1; });
  $('#reportBox').innerHTML = `
    - ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b>${_members.length}</b><br>
    - ‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î: <b>${openFines}</b> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br>
    - ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ï‡∏≤‡∏°‡∏ö‡πâ‡∏≤‡∏ô: <b>${Object.entries(byHouse).map(([k,v])=>`${k}:${v}`).join(', ')}</b>
  `;
}

/* ===== REALTIME ===== */
function subscribeRealtime(){
  sb.channel('live-sync')
    .on('postgres_changes',{ event:'*', schema:'public', table:'users' }, async()=>{ await loadMembers(); fillMemberSelects(); renderReports(); })
    .on('postgres_changes',{ event:'*', schema:'public', table:'items' }, async()=>{ await loadItems(); })
    .on('postgres_changes',{ event:'*', schema:'public', table:'activities' }, async()=>{ await loadActs(); })
    .on('postgres_changes',{ event:'*', schema:'public', table:'attendance' }, async()=>{ await loadActs(); await loadFines(); renderReports(); })
    .on('postgres_changes',{ event:'*', schema:'public', table:'fines' }, async()=>{ await loadFines(); await loadLedger(); renderReports(); })
    .on('postgres_changes',{ event:'*', schema:'public', table:'ledger' }, async()=>{ await loadLedger(); })
    .on('postgres_changes',{ event:'*', schema:'public', table:'leave_requests' }, async()=>{ await loadLeaves(); })
    .subscribe();
}

/* ===== Wire buttons (after auth) ===== */
$('#addItem').disabled = false;
</script>
</body>
</html>
